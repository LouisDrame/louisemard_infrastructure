version: "3"

networks: 
    gitea: 
        external: false

services:
    server:
        image: docker.gitea.com/gitea:1.24.6 
        container_name: gitea
        environment:
            - USER_UID=1000
            - USER_GID=1000
            - GITEA__database__DB_TYPE=mysql
            - GITEA__database__HOST=gitea_db:3306
            - GITEA__database__NAME=gitea
            - GITEA__database__USER=gitea
            - GITEA__database__PASSWD={{ gitea_db_password }}
            # SMTP Configuration
            - GITEA__mailer__ENABLED=true
            - GITEA__mailer__PROTOCOL=smtp
            - GITEA__mailer__SMTP_ADDR={{ gitea_smtp_host }}
            - GITEA__mailer__SMTP_PORT={{ gitea_smtp_port }}
            - GITEA__mailer__USER={{ gitea_smtp_user }}
            - GITEA__mailer__PASSWD={{ gitea_smtp_password }}
            - GITEA__mailer__FROM={{ gitea_smtp_from }}
            - GITEA__mailer__FROM_DISPLAY_NAME_FORMAT={{ gitea_mail_name | default(gitea_domain) }}
        restart: always
        networks:
            - gitea
        volumes:
            - {{ gitea_dir }}/gitea:/data
            - /etc/timezone:/etc/timezone:ro
            - /etc/localtime:/etc/localtime:ro
        ports:
            - "3000:3000"
            - "2222:22"
        depends_on:
            - gitea_db
    gitea_db:
        image: docker.io/mysql:8
        container_name: gitea_db
        environment:
            - MYSQL_ROOT_PASSWORD={{ gitea_db_root_password }}
            - MYSQL_DATABASE=gitea
            - MYSQL_USER=gitea
            - MYSQL_PASSWORD={{ gitea_db_password }}
        restart: always
        networks:
            - gitea
        volumes:
            - ./mysql:/var/lib/mysql
        ports:
            - "3306:3306"